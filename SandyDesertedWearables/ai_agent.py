
# ai_agent.py - ูููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุชุทูุฑ
import os
from langchain.agents import AgentExecutor, create_openai_tools_agent
from langchain_openai import ChatOpenAI
from langchain.prompts import ChatPromptTemplate
from langchain.memory import ConversationBufferWindowMemory
from tools import ALL_TOOLS
from dotenv import load_dotenv

load_dotenv()

class SmartMediaAIAgent:
    def __init__(self):
        # ุฅุนุฏุงุฏ ุงููููุฐุฌ
        self.llm = ChatOpenAI(
            base_url="https://openrouter.ai/api/v1",
            api_key=os.getenv("OPENROUTER_API_KEY"),
            model="microsoft/phi-3-mini-128k-instruct:free",
            temperature=0.7
        )
        
        # ุฅุนุฏุงุฏ ุงูุฐุงูุฑุฉ
        self.memory = ConversationBufferWindowMemory(
            memory_key="chat_history",
            return_messages=True,
            k=10  # ุญูุธ ุขุฎุฑ 10 ุฑุณุงุฆู
        )
        
        # ูุงูุจ ุงูุชุนูููุงุช
        self.prompt = ChatPromptTemplate.from_messages([
            ("system", self._get_system_instructions()),
            ("placeholder", "{chat_history}"),
            ("human", "{input}"),
            ("placeholder", "{agent_scratchpad}")
        ])
        
        # ุฅูุดุงุก ุงููููู
        self.agent = create_openai_tools_agent(
            llm=self.llm,
            tools=ALL_TOOLS,
            prompt=self.prompt
        )
        
        # ูููุฐ ุงููููู
        self.executor = AgentExecutor(
            agent=self.agent,
            tools=ALL_TOOLS,
            memory=self.memory,
            verbose=True,
            handle_parsing_errors=True,
            max_iterations=5
        )
    
    def _get_system_instructions(self):
        return """
ุฃูุช Smart Media AI Assistant - ูููู ุฐูุงุก ุงุตุทูุงุนู ูุญุชุฑู ููุชุทูุฑ ูู ุชูููุฌุฑุงู.

๐ฏ **ูููุชู ุงูุฃุณุงุณูุฉ:**
- ูุณุงุนุฏุฉ ุงููุณุชุฎุฏููู ูู ุชุญููู ูุชุญููู ููุนุงูุฌุฉ ุงููุณุงุฆุท
- ุงูุชูุงุนู ุจุทุฑููุฉ ุฐููุฉ ููุฏูุฉ ููุญุชุฑูุฉ
- ุงุณุชุฎุฏุงู ุงูุฃุฏูุงุช ุงููุชุงุญุฉ ูุชูููุฐ ุทูุจุงุช ุงููุณุชุฎุฏููู

๐๏ธ **ุงูุฃุฏูุงุช ุงููุชุงุญุฉ ูู:**
1. advanced_video_downloader - ุชุญููู ููุฏูููุงุช ุจุฌูุฏุงุช ูุฎุชููุฉ
2. advanced_video_info - ุงุณุชุฎุฑุงุฌ ูุนูููุงุช ุชูุตูููุฉ ุนู ุงูููุฏูููุงุช  
3. file_converter - ุชุญููู ุจูู ุตูุบ ูุฎุชููุฉ
4. image_processor - ูุนุงูุฌุฉ ูุชุญููู ุงูุตูุฑ
5. zip_manager - ุถุบุท ููู ุถุบุท ุงููููุงุช
6. video_editor - ุชูุทูุน ูุชุญุฑูุฑ ุงูููุฏูููุงุช

๐ **ููุงุนุฏ ุงูุชูุงุนู:**
- ุงุจุฏุฃ ุฏุงุฆูุงู ุจููู ุทูุจ ุงููุณุชุฎุฏู ุจุฏูุฉ
- ุฅุฐุง ูุงู ููุงู ุฑุงุจุทุ ุงุณุชุฎุฑุฌ ูุนูููุงุชู ุฃููุงู
- ุงุนุฑุถ ุฎูุงุฑุงุช ูุงุถุญุฉ ูููุณุชุฎุฏู (ุฌูุฏุงุชุ ุตูุบุ ุฅูุฎ)
- ุงุณุชุฎุฏู ุงูุฅูููุฌู ูุฌุนู ุงูุชูุงุนู ุฃูุซุฑ ุญูููุฉ
- ูุฏู ุชุญุฏูุซุงุช ุนู ุญุงูุฉ ุงูุนูููุงุช ุงูุฌุงุฑูุฉ
- ุงุดุฑุญ ูููุณุชุฎุฏู ูุง ุชูุนูู ุฎุทูุฉ ุจุฎุทูุฉ

๐ก **ุฃูุซูุฉ ููุชูุงุนู:**

ุนูุฏ ุงุณุชูุงู ุฑุงุจุท:
"๐ ุฌุงุฑู ูุญุต ุงูุฑุงุจุท ูุฌูุจ ุงููุนูููุงุช..."
[ุงุณุชุฎุฏู advanced_video_info]
"๐ ุชู ุงูุนุซูุฑ ุนูู ุงูููุฏูู! ุงุฎุชุฑ ููุน ุงูุชุญููู:
๐ฌ ููุฏูู - ุฌูุฏุฉ ุนุงููุฉ (1080p)
๐ฑ ููุฏูู - ุฌูุฏุฉ ูุชูุณุทุฉ (720p) 
๐ต ุตูุช ููุท (MP3)
โน๏ธ ูุนูููุงุช ููุตูุฉ"

ุนูุฏ ุทูุจ ุชุญููู:
"๐ ุฌุงุฑู ุชุญููู ุงูููู ุฅูู ุงูุตูุบุฉ ุงููุทููุจุฉ..."
[ุงุณุชุฎุฏู file_converter]
"โ ุชู ุงูุชุญููู ุจูุฌุงุญ! ุงูููู ุฌุงูุฒ ููุชุญููู."

๐จ **ุชุนูููุงุช ูููุฉ:**
- ูุง ุชุญุงูู ุชูููุฐ ุนูููุงุช ุจุฏูู ุงุณุชุฎุฏุงู ุงูุฃุฏูุงุช ุงููุญุฏุฏุฉ
- ุฅุฐุง ูุดูุช ุฃุฏุงุฉุ ุญุงูู ุทุฑููุฉ ุจุฏููุฉ ุฃู ุงุดุฑุญ ุงูุณุจุจ
- ุงุญุฑุต ุนูู ุฅุนุทุงุก ุฑุฏูุฏ ูููุฏุฉ ุญุชู ูู ุญุงูุฉ ุงูุฃุฎุทุงุก
- ุชุฐูุฑ ุชูุงุตูู ุงููุญุงุฏุซุฉ ูุงุณุชุฎุฏู ุงูุฐุงูุฑุฉ ุจุฐูุงุก

๐จ **ุฃุณููุจ ุงูุชูุงุตู:**
- ูู ูุฏูุฏุงู ููุชูุงุนูุงู
- ุงุณุชุฎุฏู ุงูุฅูููุฌู ุจุดูู ููุงุณุจ
- ุงูุชุจ ุจูุถูุญ ูุจุณุงุทุฉ
- ูุฏู ุฎูุงุฑุงุช ูุงุถุญุฉ ูููุณุชุฎุฏู
- ุงุดุฑุญ ุงูุนูููุงุช ุงูุชูููุฉ ุจุทุฑููุฉ ูุจุณุทุฉ
        """
    
    def process_message(self, user_message: str, user_id: str = None) -> str:
        """ูุนุงูุฌุฉ ุฑุณุงูุฉ ุงููุณุชุฎุฏู ูุฅุฑุฌุงุน ุงูุฑุฏ"""
        try:
            # ุฅุถุงูุฉ ูุนุฑู ุงููุณุชุฎุฏู ููุณูุงู ุฅุฐุง ูุงู ูุชุงุญุงู
            context = f"[ุงููุณุชุฎุฏู {user_id}]: {user_message}" if user_id else user_message
            
            response = self.executor.invoke({
                "input": context
            })
            
            return response.get('output', 'ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ุงููุนุงูุฌุฉ.')
            
        except Exception as e:
            return f"โ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุทูุจ: {str(e)[:100]}..."
    
    def get_available_tools_info(self) -> str:
        """ุฅุฑุฌุงุน ูุนูููุงุช ุนู ุงูุฃุฏูุงุช ุงููุชุงุญุฉ"""
        tools_info = """
๐๏ธ **ุงูุฃุฏูุงุช ุงููุชุงุญุฉ ูู ุงููุธุงู:**

๐น **ุชุญููู ุงูููุฏูููุงุช ุงููุชุทูุฑ**
- ุฏุนู ุฌููุน ุงูููุตุงุช (YouTube, TikTok, Instagram, ุฅูุฎ)
- ุฌูุฏุงุช ูุชุนุฏุฏุฉ (4K, 1080p, 720p, 480p)
- ุชุญููู ุงูุตูุช ุจุตูุบ ูุฎุชููุฉ

๐ **ุชุญููู ุงููููุงุช**
- ุชุญููู ุจูู ุตูุบ ุงูููุฏูู ูุงูุตูุช
- ุฏุนู MP4, MP3, WAV, AVI, MOV
- ุชุญุณูู ุงูุฌูุฏุฉ ูุงูุญุฌู

๐ผ๏ธ **ูุนุงูุฌุฉ ุงูุตูุฑ**  
- ุชุบููุฑ ุงูุญุฌู ูุงูุถุบุท
- ุชุญููู ุจูู ุงูุตูุบ
- ุชุญุณูู ุงูุฌูุฏุฉ

๐ฆ **ุฅุฏุงุฑุฉ ุงููููุงุช ุงููุถุบูุทุฉ**
- ุถุบุท ุงููููุงุช ูู ZIP
- ูู ุงูุถุบุท
- ุฏุนู ูููุงุช ูุชุนุฏุฏุฉ

โ๏ธ **ุชุญุฑูุฑ ุงูููุฏูู**
- ุชูุทูุน ุงูููุฏูููุงุช
- ุงุณุชุฎุฑุงุฌ ููุงุทุน ูุญุฏุฏุฉ
- ุชุญุฑูุฑ ุจุณูุท

๐ **ูุนูููุงุช ุชูุตูููุฉ**
- ุชุญููู ุงููุณุงุฆุท
- ุฅุญุตุงุฆูุงุช ูุชูุฏูุฉ
- ูุนุงููุฉ ูุจู ุงูุชุญููู
        """
        return tools_info
    
    def clear_memory(self):
        """ูุณุญ ุฐุงูุฑุฉ ุงููุญุงุฏุซุฉ"""
        self.memory.clear()
        return "๐งน ุชู ูุณุญ ุฐุงูุฑุฉ ุงููุญุงุฏุซุฉ."

# ุฅูุดุงุก ูุซูู ูุญูุฏ ูู ุงููููู
smart_agent = SmartMediaAIAgent()
